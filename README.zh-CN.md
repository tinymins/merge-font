# Merge Font - 字体合并工具

[English](README.md)

一个用于合并 TrueType 字体并支持自定义码点映射的 Python 工具，专为中文简繁体字符转换设计。

## 功能特性

- **单字体转换**：将字体转换为支持简体显示繁体字形（或反之）
- **字体合并**：将一个字体的字形合并到另一个字体，并进行码点重映射
- **多种转换模式**：支持多种中文字符映射模式
- **灵活的 cmap 支持**：可控制更新哪些 cmap 格式版本

## 环境要求

- Python 3.7+
- [fonttools](https://github.com/fonttools/fonttools)（用于 ttx 命令）

## 安装

```bash
# 安装 fonttools 以支持 ttx
pip install fonttools

# 或使用提供的批处理文件（Windows）
install-env.bat
```

## 使用方法

### 单字体转换模式（推荐）

将单个字体转换为支持简繁映射：

```bash
python merge-font.py <预设> <输入字体> [-o 输出字体]
```

**示例**：将繁体中文字体转换为在使用简体码点时显示繁体字形：

```bash
# 最简用法（输出到 我的字体·繁体_Hant2Hans.ttf）
python merge-font.py Hant2Hans "我的字体·繁体.ttf"

# 指定输出路径
python merge-font.py Hant2Hans "我的字体·繁体.ttf" -o "我的字体·繁体风格.ttf"
```

### 字体合并模式

将一个字体的字形合并到另一个字体：

```bash
python merge-font.py <预设> <基础字体> -s <源字体> [-o 输出字体]
```

### 实战示例：创建简繁全支持字体

假设你有一个字体家族，分为繁体版（`我的字体·繁体.ttf`）和简体版（`我的字体·简体.ttf`）。以下是创建不同输出版本的方法：

**第一步：创建完整版（简繁码点都支持）**

```bash
python merge-font.py Hant2Hans "我的字体·繁体.ttf" -s "我的字体·简体.ttf" -o "我的字体·简繁全支持.ttf" --cmap 12
```

这将繁体字体作为基础，把简体字体中的简体字形映射到简体码点。结果：一个能正确显示简体和繁体文本的字体。

**第二步：创建繁体风格版（所有码点都显示繁体字形）**

```bash
python merge-font.py Hant2Hans "我的字体·简繁全支持.ttx" -s "我的字体·繁体.ttx" -o "我的字体·简体码点显示繁体字形.ttf" --overwrite --cmap 12
```

这将简体字形覆盖为繁体字形。结果：一个无论文本是简体还是繁体码点，都显示繁体字形的字体。

| 输出文件 | 说明 | 适用场景 |
|----------|------|----------|
| `我的字体·简繁全支持.ttf` | 简体码点 → 简体字形，繁体码点 → 繁体字形 | 标准 CJK 支持 |
| `我的字体·简体码点显示繁体字形.ttf` | 所有码点 → 繁体字形 | 在简体系统上想看繁体的用户 |

## 预设

| 预设 | 说明 |
|------|------|
| `Hans2Hant` | 简体中文字形 → 繁体中文码点 |
| `Hant2Hans` | 繁体中文字形 → 简体中文码点 |
| `Hans` | 复制所有简体中文字形到基础字体 |
| `Hant` | 复制所有繁体中文字形到基础字体 |

### 使用场景

- **`Hant2Hans`**：当你有一个繁体中文字体，希望在文本使用简体中文码点时也能显示繁体字形
- **`Hans2Hant`**：当你有一个简体中文字体，希望在文本使用繁体中文码点时也能显示简体字形

## 选项参数

### `-o, --output <字体路径>`

指定输出字体路径。如果不提供，默认为 `<输入文件名>_<预设>.ttf`。

### `-s, --source <字体路径>`

指定要读取字形的源字体文件。如果不提供，则使用输入字体作为源和目标。

### `--cmap <版本列表>`

指定要更新的 cmap 格式版本。默认情况下会处理所有 cmap 格式。

```bash
# 仅更新 cmap 格式 12
--cmap 12

# 更新 cmap 格式 4 和 12
--cmap 4,12
```

### `--overwrite`

覆盖基础字体中已存在的字形。默认情况下，非空字形会被保留。

### `--optimize`

从 cmap 表中移除空字形，以减小文件大小并避免潜在的格式限制。

## 常见问题

### cmap 格式错误

某些字体包含的 cmap 格式（如 `cmap_format_0`、`cmap_format_2`、`cmap_format_6`）仅支持有限的字符范围。如果在编译时遇到错误：

1. 使用 `--cmap 4,12` 选项仅更新支持的格式
2. 使用 `--optimize` 选项移除空字形

```bash
python merge-font.py Hant2Hans "font.ttf" -o "output.ttf" --cmap 4,12 --optimize
```

### 输出文件过大

如果输出字体文件过大，使用 `--optimize` 参数从 cmap 表中移除空字形条目。

## 工作原理

1. **解析字体**：使用 fonttools 将 TTF 文件转换为 TTX（XML 格式）
2. **构建字形字典**：按 Unicode 码点索引字形
3. **应用映射**：根据选定模式将字形从源字体复制到目标码点
4. **更新表数据**：更新 glyf、cmap、hmtx、vmtx 和 GlyphOrder 表
5. **编译输出**：将修改后的 TTX 转换回 TTF 格式

## 许可证

MIT License

## 作者

Emil Zhai
